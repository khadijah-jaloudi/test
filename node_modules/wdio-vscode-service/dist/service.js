import fs from 'node:fs/promises';
import url from 'node:url';
import util from 'node:util';
import path from 'node:path';
import slash from 'slash';
import tmp from 'tmp-promise';
import logger from '@wdio/logger';
import getPort from 'get-port';
import decamelize from 'decamelize';
import { WebSocketServer } from 'ws';
import { SevereServiceError } from 'webdriverio';
import { Workbench } from './pageobjects/index.js';
import { getLocators, getValueSuffix, isVSCodeCapability } from './utils.js';
import { VSCODE_APPLICATION_ARGS, DEFAULT_VSCODE_SETTINGS, DEFAULT_PROXY_OPTIONS, SETTINGS_KEY, VSCODE_CAPABILITY_KEY, DEFAULT_VSCODE_WEB_PORT } from './constants.js';
const log = logger('wdio-vscode-service');
const __dirname = url.fileURLToPath(new URL('.', import.meta.url));
export default class VSCodeWorkerService {
    constructor(_, _capabilities) {
        this._capabilities = _capabilities;
        this._messageId = 0;
        this._pendingMessages = new Map();
        this._isWebSession = false;
        this._vscodeOptions = this._capabilities[VSCODE_CAPABILITY_KEY] || {};
        this._proxyOptions = { ...DEFAULT_PROXY_OPTIONS, ...this._vscodeOptions.vscodeProxyOptions };
    }
    _handleIncoming(data) {
        try {
            const message = JSON.parse(data.toString('utf-8'));
            const resolver = this._pendingMessages.get(message.id);
            if (!resolver) {
                log.error(`Couldn't find remote message resolver with id ${message.id}`);
                return;
            }
            resolver(message.error, message.result);
        }
        catch (err) {
            log.error(`Error parsing remote response: ${err.message}`);
        }
    }
    async beforeSession(option, capabilities) {
        this._isWebSession = capabilities.browserName !== 'vscode';
        /**
         * only run setup for VSCode capabilities
         */
        if (!isVSCodeCapability(capabilities)) {
            return;
        }
        /**
         * if we run tests for a web extension
         */
        if (this._isWebSession) {
            const serverOptions = capabilities[VSCODE_CAPABILITY_KEY]?.serverOptions;
            option.baseUrl = util.format('http://%s:%s', serverOptions?.hostname || 'localhost', (serverOptions?.port || DEFAULT_VSCODE_WEB_PORT).toString());
            log.info(`Run VSCode as web app on ${option.baseUrl}`);
            return;
        }
        const customArgs = { ...VSCODE_APPLICATION_ARGS };
        const storagePath = this._vscodeOptions.storagePath ?? (await tmp.dir()).path;
        const userSettingsPath = path.join(storagePath, 'settings', 'User');
        const userSettings = {
            ...DEFAULT_VSCODE_SETTINGS,
            ...(this._vscodeOptions.userSettings || {})
        };
        if (!this._vscodeOptions.extensionPath) {
            throw new SevereServiceError('No extension path provided');
        }
        if (this._proxyOptions.enable) {
            const port = await getPort({ port: this._proxyOptions.port });
            userSettings[SETTINGS_KEY].port = port;
            log.info(`Start VSCode proxy server on port ${port}`);
            const wss = this._wss = new WebSocketServer({ port });
            this._promisedSocket = new Promise((resolve, reject) => {
                const socketTimeout = setTimeout(() => reject(new Error('Connection timeout exceeded')), this._proxyOptions.connectionTimeout);
                wss.on('connection', (socket) => {
                    log.info('Connected with VSCode workbench');
                    resolve(socket);
                    clearTimeout(socketTimeout);
                    socket.on('message', this._handleIncoming.bind(this));
                });
            });
        }
        customArgs.extensionDevelopmentPath = slash(this._vscodeOptions.extensionPath);
        customArgs.extensionTestsPath = slash(path.join(__dirname, 'proxy', 'cjs', 'entry.js'));
        customArgs.userDataDir = slash(path.join(storagePath, 'settings'));
        customArgs.extensionsDir = slash(path.join(storagePath, 'extensions'));
        customArgs.vscodeBinaryPath = this._vscodeOptions.binary;
        log.info(`Setting up VSCode directory at ${userSettingsPath}`);
        await fs.mkdir(userSettingsPath, { recursive: true });
        await fs.writeFile(path.join(userSettingsPath, 'settings.json'), JSON.stringify(userSettings), 'utf-8');
        if (this._vscodeOptions.workspacePath) {
            customArgs.folderUri = `file:${slash(this._vscodeOptions.workspacePath)}`;
        }
        if (this._vscodeOptions.filePath) {
            customArgs.fileUri = `file:${slash(this._vscodeOptions.filePath)}`;
        }
        if (this._vscodeOptions.verboseLogging) {
            customArgs.verbose = true;
            customArgs.logExtensionHostCommunication = true;
        }
        const binary = path.join(__dirname, 'chromium', `index.${process.platform === 'win32' ? 'exe' : 'js'}`);
        const args = Object.entries({ ...customArgs, ...this._vscodeOptions.vscodeArgs }).reduce((prev, [key, value]) => [
            ...prev,
            `--${decamelize(key, { separator: '-' })}${getValueSuffix(value)}`
        ], []);
        /**
         * need to rename capability back to Chrome otherwise Chromedriver
         * won't recognise this capability
         */
        capabilities.browserName = 'chrome';
        capabilities['goog:chromeOptions'] = { binary, args, windowTypes: ['webview'] };
        log.info(`Start VSCode: ${binary} ${args.join(' ')}`);
    }
    async before(capabilities, __, browser) {
        /**
         * only run setup for VSCode capabilities
         */
        if (!isVSCodeCapability(capabilities)) {
            return;
        }
        /**
         * open VSCode web when testing web extensions
         */
        if (this._isWebSession) {
            await browser.url('/');
        }
        this._browser = browser;
        const locators = await getLocators(capabilities.browserVersion || 'insiders');
        const workbenchPO = new Workbench(locators);
        this._browser.addCommand('getWorkbench', () => workbenchPO.wait());
        this._browser.addCommand('executeWorkbench', this._executeVSCode.bind(this));
        this._browser.addCommand('getVSCodeVersion', () => capabilities.browserVersion);
        this._browser.addCommand('isVSCodeWebSession', () => this._isWebSession);
        this._browser.addCommand('getVSCodeChannel', () => (capabilities.browserVersion === 'insiders' ? 'insiders' : 'vscode'));
        await workbenchPO.elem.waitForExist();
        /**
         * VSCode in the browser doesn't allow to have a file directly opened,
         * therefore we need to open it automatically
         */
        if (this._isWebSession && this._vscodeOptions.filePath && this._vscodeOptions.workspacePath) {
            const sections = this._vscodeOptions.filePath.replace(this._vscodeOptions.workspacePath, '')
                .split(path.sep).filter(Boolean);
            const fileExplorer = await browser.$('.explorer-folders-view');
            while (sections.length > 0) {
                const entry = sections.shift();
                await fileExplorer.$(`span=${entry}`).click();
            }
        }
    }
    async after() {
        if (!isVSCodeCapability(this._capabilities)
            || !this._browser
            || !this._capabilities[VSCODE_CAPABILITY_KEY]?.verboseLogging) {
            return;
        }
        const logs = await this._browser.getLogs('browser').then((res) => res, (err) => err);
        if (logs instanceof Error) {
            return;
        }
        for (const l of logs) {
            log.info(`[${(new Date(l.timestamp)).toISOString()}]`
                + ` - ${l.source} - ${l.message}`);
        }
        if (this._wss) {
            this._wss.close();
        }
    }
    async _executeVSCode(fn, ...params) {
        if (!this._promisedSocket || this._isWebSession) {
            const errorMessage = this._isWebSession
                ? 'not support when testing web extensions'
                : 'see "vscodeProxyOptions" option in service docs';
            throw new Error(`VSCode API proxy not enabled, ${errorMessage}`);
        }
        const socket = await this._promisedSocket;
        const proxyFn = typeof fn === 'function'
            ? fn.toString()
            : fn;
        socket.send(JSON.stringify({
            id: this._messageId,
            fn: proxyFn,
            params
        }));
        const returnVal = new Promise((resolve, reject) => {
            const cmdTimeout = setTimeout(() => reject(new Error('Remote command timeout exceeded')), this._proxyOptions.commandTimeout);
            this._pendingMessages.set(this._messageId, (error, result) => {
                clearTimeout(cmdTimeout);
                if (error) {
                    reject(new Error(error));
                    return;
                }
                resolve(result);
            });
        });
        this._messageId += 1;
        return returnVal;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLGtCQUFrQixDQUFBO0FBQ2pDLE9BQU8sR0FBRyxNQUFNLFVBQVUsQ0FBQTtBQUMxQixPQUFPLElBQUksTUFBTSxXQUFXLENBQUE7QUFDNUIsT0FBTyxJQUFJLE1BQU0sV0FBVyxDQUFBO0FBQzVCLE9BQU8sS0FBSyxNQUFNLE9BQU8sQ0FBQTtBQUN6QixPQUFPLEdBQUcsTUFBTSxhQUFhLENBQUE7QUFDN0IsT0FBTyxNQUFNLE1BQU0sY0FBYyxDQUFBO0FBQ2pDLE9BQU8sT0FBTyxNQUFNLFVBQVUsQ0FBQTtBQUM5QixPQUFPLFVBQVUsTUFBTSxZQUFZLENBQUE7QUFDbkMsT0FBTyxFQUFFLGVBQWUsRUFBYSxNQUFNLElBQUksQ0FBQTtBQUUvQyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxhQUFhLENBQUE7QUFFaEQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHdCQUF3QixDQUFBO0FBQ2xELE9BQU8sRUFBRSxXQUFXLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sWUFBWSxDQUFBO0FBQzVFLE9BQU8sRUFDSCx1QkFBdUIsRUFBRSx1QkFBdUIsRUFBRSxxQkFBcUIsRUFDdkUsWUFBWSxFQUFFLHFCQUFxQixFQUFFLHVCQUF1QixFQUMvRCxNQUFNLGdCQUFnQixDQUFBO0FBTXZCLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFBO0FBQ3pDLE1BQU0sU0FBUyxHQUFHLEdBQUcsQ0FBQyxhQUFhLENBQUMsSUFBSSxHQUFHLENBQUMsR0FBRyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQTtBQUNsRSxNQUFNLENBQUMsT0FBTyxPQUFPLG1CQUFtQjtJQVVwQyxZQUFhLENBQVEsRUFBVSxhQUFpQztRQUFqQyxr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QUFNLENBQUMsSUFBSSxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQTtvQkFDeEIsT0FBTTtpQkFDVDtnQkFDRCxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUE7WUFDbkIsQ0FBQyxDQUFDLENBQUE7UUFDTixDQUFDLENBQUMsQ0FBQTtRQUNGLElBQUksQ0FBQyxVQUFVLElBQUksQ0FBQyxDQUFBO1FBQ3BCLE9BQU8sU0FBUyxDQUFBO0lBQ3BCLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmcyBmcm9tICdub2RlOmZzL3Byb21pc2VzJ1xuaW1wb3J0IHVybCBmcm9tICdub2RlOnVybCdcbmltcG9ydCB1dGlsIGZyb20gJ25vZGU6dXRpbCdcbmltcG9ydCBwYXRoIGZyb20gJ25vZGU6cGF0aCdcbmltcG9ydCBzbGFzaCBmcm9tICdzbGFzaCdcbmltcG9ydCB0bXAgZnJvbSAndG1wLXByb21pc2UnXG5pbXBvcnQgbG9nZ2VyIGZyb20gJ0B3ZGlvL2xvZ2dlcidcbmltcG9ydCBnZXRQb3J0IGZyb20gJ2dldC1wb3J0J1xuaW1wb3J0IGRlY2FtZWxpemUgZnJvbSAnZGVjYW1lbGl6ZSdcbmltcG9ydCB7IFdlYlNvY2tldFNlcnZlciwgV2ViU29ja2V0IH0gZnJvbSAnd3MnXG5pbXBvcnQgeyBTZXJ2aWNlcywgT3B0aW9ucyB9IGZyb20gJ0B3ZGlvL3R5cGVzJ1xuaW1wb3J0IHsgU2V2ZXJlU2VydmljZUVycm9yIH0gZnJvbSAnd2ViZHJpdmVyaW8nXG5cbmltcG9ydCB7IFdvcmtiZW5jaCB9IGZyb20gJy4vcGFnZW9iamVjdHMvaW5kZXguanMnXG5pbXBvcnQgeyBnZXRMb2NhdG9ycywgZ2V0VmFsdWVTdWZmaXgsIGlzVlNDb2RlQ2FwYWJpbGl0eSB9IGZyb20gJy4vdXRpbHMuanMnXG5pbXBvcnQge1xuICAgIFZTQ09ERV9BUFBMSUNBVElPTl9BUkdTLCBERUZBVUxUX1ZTQ09ERV9TRVRUSU5HUywgREVGQVVMVF9QUk9YWV9PUFRJT05TLFxuICAgIFNFVFRJTkdTX0tFWSwgVlNDT0RFX0NBUEFCSUxJVFlfS0VZLCBERUZBVUxUX1ZTQ09ERV9XRUJfUE9SVFxufSBmcm9tICcuL2NvbnN0YW50cy5qcydcbmltcG9ydCB0eXBlIHtcbiAgICBWU0NvZGVDYXBhYmlsaXRpZXMsIFdESU9Mb2dzLCBBcmdzUGFyYW1zLCBSZW1vdGVDb21tYW5kLCBSZW1vdGVSZXNwb25zZSxcbiAgICBQZW5kaW5nTWVzc2FnZVJlc29sdmVyLCBWU0NvZGVQcm94eU9wdGlvbnMsIFZTQ29kZU9wdGlvbnNcbn0gZnJvbSAnLi90eXBlcydcblxuY29uc3QgbG9nID0gbG9nZ2VyKCd3ZGlvLXZzY29kZS1zZXJ2aWNlJylcbmNvbnN0IF9fZGlybmFtZSA9IHVybC5maWxlVVJMVG9QYXRoKG5ldyBVUkwoJy4nLCBpbXBvcnQubWV0YS51cmwpKVxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVlNDb2RlV29ya2VyU2VydmljZSBpbXBsZW1lbnRzIFNlcnZpY2VzLlNlcnZpY2VJbnN0YW5jZSB7XG4gICAgcHJpdmF0ZSBfYnJvd3Nlcj86IFdlYmRyaXZlcklPLkJyb3dzZXJcbiAgICBwcml2YXRlIF93c3M/OiBXZWJTb2NrZXRTZXJ2ZXJcbiAgICBwcml2YXRlIF9tZXNzYWdlSWQgPSAwXG4gICAgcHJpdmF0ZSBfcGVuZGluZ01lc3NhZ2VzID0gbmV3IE1hcDxudW1iZXIsIFBlbmRpbmdNZXNzYWdlUmVzb2x2ZXI+KClcbiAgICBwcml2YXRlIF9wcm9taXNlZFNvY2tldD86IFByb21pc2U8V2ViU29ja2V0PlxuICAgIHByaXZhdGUgX3Byb3h5T3B0aW9uczogVlNDb2RlUHJveHlPcHRpb25zXG4gICAgcHJpdmF0ZSBfdnNjb2RlT3B0aW9uczogVlNDb2RlT3B0aW9uc1xuICAgIHByaXZhdGUgX2lzV2ViU2Vzc2lvbiA9IGZhbHNlXG5cbiAgICBjb25zdHJ1Y3RvciAoXzogbmV2ZXIsIHByaXZhdGUgX2NhcGFiaWxpdGllczogVlNDb2RlQ2FwYWJpbGl0aWVzKSB7XG4gICAgICAgIHRoaXMuX3ZzY29kZU9wdGlvbnMgPSB0aGlzLl9jYXBhYmlsaXRpZXNbVlNDT0RFX0NBUEFCSUxJVFlfS0VZXSB8fCA8VlNDb2RlT3B0aW9ucz57fVxuICAgICAgICB0aGlzLl9wcm94eU9wdGlvbnMgPSB7IC4uLkRFRkFVTFRfUFJPWFlfT1BUSU9OUywgLi4udGhpcy5fdnNjb2RlT3B0aW9ucy52c2NvZGVQcm94eU9wdGlvbnMgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX2hhbmRsZUluY29taW5nIChkYXRhOiBCdWZmZXIpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBKU09OLnBhcnNlKGRhdGEudG9TdHJpbmcoJ3V0Zi04JykpIGFzIFJlbW90ZVJlc3BvbnNlXG4gICAgICAgICAgICBjb25zdCByZXNvbHZlciA9IHRoaXMuX3BlbmRpbmdNZXNzYWdlcy5nZXQobWVzc2FnZS5pZClcblxuICAgICAgICAgICAgaWYgKCFyZXNvbHZlcikge1xuICAgICAgICAgICAgICAgIGxvZy5lcnJvcihgQ291bGRuJ3QgZmluZCByZW1vdGUgbWVzc2FnZSByZXNvbHZlciB3aXRoIGlkICR7bWVzc2FnZS5pZH1gKVxuICAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXNvbHZlcihtZXNzYWdlLmVycm9yLCBtZXNzYWdlLnJlc3VsdClcbiAgICAgICAgfSBjYXRjaCAoZXJyOiBhbnkpIHtcbiAgICAgICAgICAgIGxvZy5lcnJvcihgRXJyb3IgcGFyc2luZyByZW1vdGUgcmVzcG9uc2U6ICR7ZXJyLm1lc3NhZ2V9YClcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIGJlZm9yZVNlc3Npb24gKG9wdGlvbjogT3B0aW9ucy5UZXN0cnVubmVyLCBjYXBhYmlsaXRpZXM6IFZTQ29kZUNhcGFiaWxpdGllcykge1xuICAgICAgICB0aGlzLl9pc1dlYlNlc3Npb24gPSBjYXBhYmlsaXRpZXMuYnJvd3Nlck5hbWUgIT09ICd2c2NvZGUnXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIG9ubHkgcnVuIHNldHVwIGZvciBWU0NvZGUgY2FwYWJpbGl0aWVzXG4gICAgICAgICAqL1xuICAgICAgICBpZiAoIWlzVlNDb2RlQ2FwYWJpbGl0eShjYXBhYmlsaXRpZXMpKSB7XG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBpZiB3ZSBydW4gdGVzdHMgZm9yIGEgd2ViIGV4dGVuc2lvblxuICAgICAgICAgKi9cbiAgICAgICAgaWYgKHRoaXMuX2lzV2ViU2Vzc2lvbikge1xuICAgICAgICAgICAgY29uc3Qgc2VydmVyT3B0aW9ucyA9IGNhcGFiaWxpdGllc1tWU0NPREVfQ0FQQUJJTElUWV9LRVldPy5zZXJ2ZXJPcHRpb25zXG4gICAgICAgICAgICBvcHRpb24uYmFzZVVybCA9IHV0aWwuZm9ybWF0KFxuICAgICAgICAgICAgICAgICdodHRwOi8vJXM6JXMnLFxuICAgICAgICAgICAgICAgIHNlcnZlck9wdGlvbnM/Lmhvc3RuYW1lIHx8ICdsb2NhbGhvc3QnLFxuICAgICAgICAgICAgICAgIChzZXJ2ZXJPcHRpb25zPy5wb3J0IHx8IERFRkFVTFRfVlNDT0RFX1dFQl9QT1JUIGFzIG51bWJlcikudG9TdHJpbmcoKVxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgbG9nLmluZm8oYFJ1biBWU0NvZGUgYXMgd2ViIGFwcCBvbiAke29wdGlvbi5iYXNlVXJsfWApXG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGN1c3RvbUFyZ3M6IEFyZ3NQYXJhbXMgPSB7IC4uLlZTQ09ERV9BUFBMSUNBVElPTl9BUkdTIH1cbiAgICAgICAgY29uc3Qgc3RvcmFnZVBhdGggPSB0aGlzLl92c2NvZGVPcHRpb25zLnN0b3JhZ2VQYXRoID8/IChhd2FpdCB0bXAuZGlyKCkpLnBhdGhcbiAgICAgICAgY29uc3QgdXNlclNldHRpbmdzUGF0aCA9IHBhdGguam9pbihzdG9yYWdlUGF0aCwgJ3NldHRpbmdzJywgJ1VzZXInKVxuICAgICAgICBjb25zdCB1c2VyU2V0dGluZ3M6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7XG4gICAgICAgICAgICAuLi5ERUZBVUxUX1ZTQ09ERV9TRVRUSU5HUyxcbiAgICAgICAgICAgIC4uLih0aGlzLl92c2NvZGVPcHRpb25zLnVzZXJTZXR0aW5ncyB8fCB7fSlcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdGhpcy5fdnNjb2RlT3B0aW9ucy5leHRlbnNpb25QYXRoKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgU2V2ZXJlU2VydmljZUVycm9yKCdObyBleHRlbnNpb24gcGF0aCBwcm92aWRlZCcpXG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5fcHJveHlPcHRpb25zLmVuYWJsZSkge1xuICAgICAgICAgICAgY29uc3QgcG9ydCA9IGF3YWl0IGdldFBvcnQoeyBwb3J0OiB0aGlzLl9wcm94eU9wdGlvbnMucG9ydCB9KVxuICAgICAgICAgICAgdXNlclNldHRpbmdzW1NFVFRJTkdTX0tFWV0ucG9ydCA9IHBvcnRcbiAgICAgICAgICAgIGxvZy5pbmZvKGBTdGFydCBWU0NvZGUgcHJveHkgc2VydmVyIG9uIHBvcnQgJHtwb3J0fWApXG4gICAgICAgICAgICBjb25zdCB3c3MgPSB0aGlzLl93c3MgPSBuZXcgV2ViU29ja2V0U2VydmVyKHsgcG9ydCB9KVxuICAgICAgICAgICAgdGhpcy5fcHJvbWlzZWRTb2NrZXQgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc29ja2V0VGltZW91dCA9IHNldFRpbWVvdXQoXG4gICAgICAgICAgICAgICAgICAgICgpID0+IHJlamVjdChuZXcgRXJyb3IoJ0Nvbm5lY3Rpb24gdGltZW91dCBleGNlZWRlZCcpKSxcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcHJveHlPcHRpb25zLmNvbm5lY3Rpb25UaW1lb3V0XG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIHdzcy5vbignY29ubmVjdGlvbicsIChzb2NrZXQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbG9nLmluZm8oJ0Nvbm5lY3RlZCB3aXRoIFZTQ29kZSB3b3JrYmVuY2gnKVxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHNvY2tldClcbiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHNvY2tldFRpbWVvdXQpXG4gICAgICAgICAgICAgICAgICAgIHNvY2tldC5vbignbWVzc2FnZScsIHRoaXMuX2hhbmRsZUluY29taW5nLmJpbmQodGhpcykpXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH1cblxuICAgICAgICBjdXN0b21BcmdzLmV4dGVuc2lvbkRldmVsb3BtZW50UGF0aCA9IHNsYXNoKHRoaXMuX3ZzY29kZU9wdGlvbnMuZXh0ZW5zaW9uUGF0aClcbiAgICAgICAgY3VzdG9tQXJncy5leHRlbnNpb25UZXN0c1BhdGggPSBzbGFzaChwYXRoLmpvaW4oX19kaXJuYW1lLCAncHJveHknLCAnY2pzJywgJ2VudHJ5LmpzJykpXG4gICAgICAgIGN1c3RvbUFyZ3MudXNlckRhdGFEaXIgPSBzbGFzaChwYXRoLmpvaW4oc3RvcmFnZVBhdGgsICdzZXR0aW5ncycpKVxuICAgICAgICBjdXN0b21BcmdzLmV4dGVuc2lvbnNEaXIgPSBzbGFzaChwYXRoLmpvaW4oc3RvcmFnZVBhdGgsICdleHRlbnNpb25zJykpXG4gICAgICAgIGN1c3RvbUFyZ3MudnNjb2RlQmluYXJ5UGF0aCA9IHRoaXMuX3ZzY29kZU9wdGlvbnMuYmluYXJ5IGFzIHN0cmluZ1xuXG4gICAgICAgIGxvZy5pbmZvKGBTZXR0aW5nIHVwIFZTQ29kZSBkaXJlY3RvcnkgYXQgJHt1c2VyU2V0dGluZ3NQYXRofWApXG4gICAgICAgIGF3YWl0IGZzLm1rZGlyKHVzZXJTZXR0aW5nc1BhdGgsIHsgcmVjdXJzaXZlOiB0cnVlIH0pXG4gICAgICAgIGF3YWl0IGZzLndyaXRlRmlsZShcbiAgICAgICAgICAgIHBhdGguam9pbih1c2VyU2V0dGluZ3NQYXRoLCAnc2V0dGluZ3MuanNvbicpLFxuICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkodXNlclNldHRpbmdzKSxcbiAgICAgICAgICAgICd1dGYtOCdcbiAgICAgICAgKVxuXG4gICAgICAgIGlmICh0aGlzLl92c2NvZGVPcHRpb25zLndvcmtzcGFjZVBhdGgpIHtcbiAgICAgICAgICAgIGN1c3RvbUFyZ3MuZm9sZGVyVXJpID0gYGZpbGU6JHtzbGFzaCh0aGlzLl92c2NvZGVPcHRpb25zLndvcmtzcGFjZVBhdGgpfWBcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLl92c2NvZGVPcHRpb25zLmZpbGVQYXRoKSB7XG4gICAgICAgICAgICBjdXN0b21BcmdzLmZpbGVVcmkgPSBgZmlsZToke3NsYXNoKHRoaXMuX3ZzY29kZU9wdGlvbnMuZmlsZVBhdGgpfWBcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLl92c2NvZGVPcHRpb25zLnZlcmJvc2VMb2dnaW5nKSB7XG4gICAgICAgICAgICBjdXN0b21BcmdzLnZlcmJvc2UgPSB0cnVlXG4gICAgICAgICAgICBjdXN0b21BcmdzLmxvZ0V4dGVuc2lvbkhvc3RDb21tdW5pY2F0aW9uID0gdHJ1ZVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgYmluYXJ5ID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJ2Nocm9taXVtJywgYGluZGV4LiR7cHJvY2Vzcy5wbGF0Zm9ybSA9PT0gJ3dpbjMyJyA/ICdleGUnIDogJ2pzJ31gKVxuICAgICAgICBjb25zdCBhcmdzID0gT2JqZWN0LmVudHJpZXMoeyAuLi5jdXN0b21BcmdzLCAuLi50aGlzLl92c2NvZGVPcHRpb25zLnZzY29kZUFyZ3MgfSkucmVkdWNlKFxuICAgICAgICAgICAgKHByZXYsIFtrZXksIHZhbHVlXSkgPT4gW1xuICAgICAgICAgICAgICAgIC4uLnByZXYsXG4gICAgICAgICAgICAgICAgYC0tJHtkZWNhbWVsaXplKGtleSwgeyBzZXBhcmF0b3I6ICctJyB9KX0ke2dldFZhbHVlU3VmZml4KHZhbHVlKX1gXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgW10gYXMgc3RyaW5nW11cbiAgICAgICAgKVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBuZWVkIHRvIHJlbmFtZSBjYXBhYmlsaXR5IGJhY2sgdG8gQ2hyb21lIG90aGVyd2lzZSBDaHJvbWVkcml2ZXJcbiAgICAgICAgICogd29uJ3QgcmVjb2duaXNlIHRoaXMgY2FwYWJpbGl0eVxuICAgICAgICAgKi9cbiAgICAgICAgY2FwYWJpbGl0aWVzLmJyb3dzZXJOYW1lID0gJ2Nocm9tZSdcbiAgICAgICAgY2FwYWJpbGl0aWVzWydnb29nOmNocm9tZU9wdGlvbnMnXSA9IHsgYmluYXJ5LCBhcmdzLCB3aW5kb3dUeXBlczogWyd3ZWJ2aWV3J10gfVxuICAgICAgICBsb2cuaW5mbyhgU3RhcnQgVlNDb2RlOiAke2JpbmFyeX0gJHthcmdzLmpvaW4oJyAnKX1gKVxuICAgIH1cblxuICAgIGFzeW5jIGJlZm9yZSAoY2FwYWJpbGl0aWVzOiBWU0NvZGVDYXBhYmlsaXRpZXMsIF9fOiBuZXZlciwgYnJvd3NlcjogV2ViZHJpdmVySU8uQnJvd3Nlcikge1xuICAgICAgICAvKipcbiAgICAgICAgICogb25seSBydW4gc2V0dXAgZm9yIFZTQ29kZSBjYXBhYmlsaXRpZXNcbiAgICAgICAgICovXG4gICAgICAgIGlmICghaXNWU0NvZGVDYXBhYmlsaXR5KGNhcGFiaWxpdGllcykpIHtcbiAgICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIG9wZW4gVlNDb2RlIHdlYiB3aGVuIHRlc3Rpbmcgd2ViIGV4dGVuc2lvbnNcbiAgICAgICAgICovXG4gICAgICAgIGlmICh0aGlzLl9pc1dlYlNlc3Npb24pIHtcbiAgICAgICAgICAgIGF3YWl0IGJyb3dzZXIudXJsKCcvJylcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX2Jyb3dzZXIgPSBicm93c2VyXG4gICAgICAgIGNvbnN0IGxvY2F0b3JzID0gYXdhaXQgZ2V0TG9jYXRvcnMoY2FwYWJpbGl0aWVzLmJyb3dzZXJWZXJzaW9uIHx8ICdpbnNpZGVycycpXG4gICAgICAgIGNvbnN0IHdvcmtiZW5jaFBPID0gbmV3IFdvcmtiZW5jaChsb2NhdG9ycylcbiAgICAgICAgdGhpcy5fYnJvd3Nlci5hZGRDb21tYW5kKCdnZXRXb3JrYmVuY2gnLCAoKSA9PiB3b3JrYmVuY2hQTy53YWl0KCkpXG4gICAgICAgIHRoaXMuX2Jyb3dzZXIuYWRkQ29tbWFuZCgnZXhlY3V0ZVdvcmtiZW5jaCcsIHRoaXMuX2V4ZWN1dGVWU0NvZGUuYmluZCh0aGlzKSlcbiAgICAgICAgdGhpcy5fYnJvd3Nlci5hZGRDb21tYW5kKCdnZXRWU0NvZGVWZXJzaW9uJywgKCkgPT4gY2FwYWJpbGl0aWVzLmJyb3dzZXJWZXJzaW9uKVxuICAgICAgICB0aGlzLl9icm93c2VyLmFkZENvbW1hbmQoJ2lzVlNDb2RlV2ViU2Vzc2lvbicsICgpID0+IHRoaXMuX2lzV2ViU2Vzc2lvbilcbiAgICAgICAgdGhpcy5fYnJvd3Nlci5hZGRDb21tYW5kKCdnZXRWU0NvZGVDaGFubmVsJywgKCkgPT4gKFxuICAgICAgICAgICAgY2FwYWJpbGl0aWVzLmJyb3dzZXJWZXJzaW9uID09PSAnaW5zaWRlcnMnID8gJ2luc2lkZXJzJyA6ICd2c2NvZGUnXG4gICAgICAgICkpXG4gICAgICAgIGF3YWl0IHdvcmtiZW5jaFBPLmVsZW0ud2FpdEZvckV4aXN0KClcblxuICAgICAgICAvKipcbiAgICAgICAgICogVlNDb2RlIGluIHRoZSBicm93c2VyIGRvZXNuJ3QgYWxsb3cgdG8gaGF2ZSBhIGZpbGUgZGlyZWN0bHkgb3BlbmVkLFxuICAgICAgICAgKiB0aGVyZWZvcmUgd2UgbmVlZCB0byBvcGVuIGl0IGF1dG9tYXRpY2FsbHlcbiAgICAgICAgICovXG4gICAgICAgIGlmICh0aGlzLl9pc1dlYlNlc3Npb24gJiYgdGhpcy5fdnNjb2RlT3B0aW9ucy5maWxlUGF0aCAmJiB0aGlzLl92c2NvZGVPcHRpb25zLndvcmtzcGFjZVBhdGgpIHtcbiAgICAgICAgICAgIGNvbnN0IHNlY3Rpb25zID0gdGhpcy5fdnNjb2RlT3B0aW9ucy5maWxlUGF0aC5yZXBsYWNlKHRoaXMuX3ZzY29kZU9wdGlvbnMud29ya3NwYWNlUGF0aCwgJycpXG4gICAgICAgICAgICAgICAgLnNwbGl0KHBhdGguc2VwKS5maWx0ZXIoQm9vbGVhbilcbiAgICAgICAgICAgIGNvbnN0IGZpbGVFeHBsb3JlciA9IGF3YWl0IGJyb3dzZXIuJCgnLmV4cGxvcmVyLWZvbGRlcnMtdmlldycpXG4gICAgICAgICAgICB3aGlsZSAoc2VjdGlvbnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGVudHJ5ID0gc2VjdGlvbnMuc2hpZnQoKVxuICAgICAgICAgICAgICAgIGF3YWl0IGZpbGVFeHBsb3Jlci4kKGBzcGFuPSR7ZW50cnl9YCkuY2xpY2soKVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgYWZ0ZXIgKCkge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgICAhaXNWU0NvZGVDYXBhYmlsaXR5KHRoaXMuX2NhcGFiaWxpdGllcylcbiAgICAgICAgICAgIHx8ICF0aGlzLl9icm93c2VyXG4gICAgICAgICAgICB8fCAhdGhpcy5fY2FwYWJpbGl0aWVzW1ZTQ09ERV9DQVBBQklMSVRZX0tFWV0/LnZlcmJvc2VMb2dnaW5nXG4gICAgICAgICkge1xuICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBsb2dzID0gYXdhaXQgdGhpcy5fYnJvd3Nlci5nZXRMb2dzKCdicm93c2VyJykudGhlbihcbiAgICAgICAgICAgIChyZXMpID0+IHJlcyBhcyBXRElPTG9nc1tdLFxuICAgICAgICAgICAgKGVycikgPT4gZXJyIGFzIEVycm9yXG4gICAgICAgIClcblxuICAgICAgICBpZiAobG9ncyBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuXG4gICAgICAgIGZvciAoY29uc3QgbCBvZiBsb2dzKSB7XG4gICAgICAgICAgICBsb2cuaW5mbyhcbiAgICAgICAgICAgICAgICBgWyR7KG5ldyBEYXRlKGwudGltZXN0YW1wKSkudG9JU09TdHJpbmcoKX1dYFxuICAgICAgICAgICAgICAgICsgYCAtICR7bC5zb3VyY2V9IC0gJHtsLm1lc3NhZ2V9YFxuICAgICAgICAgICAgKVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuX3dzcykge1xuICAgICAgICAgICAgdGhpcy5fd3NzLmNsb3NlKClcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgX2V4ZWN1dGVWU0NvZGUgKGZuOiBGdW5jdGlvbiB8IHN0cmluZywgLi4ucGFyYW1zOiBhbnlbXSkge1xuICAgICAgICBpZiAoIXRoaXMuX3Byb21pc2VkU29ja2V0IHx8IHRoaXMuX2lzV2ViU2Vzc2lvbikge1xuICAgICAgICAgICAgY29uc3QgZXJyb3JNZXNzYWdlID0gdGhpcy5faXNXZWJTZXNzaW9uXG4gICAgICAgICAgICAgICAgPyAnbm90IHN1cHBvcnQgd2hlbiB0ZXN0aW5nIHdlYiBleHRlbnNpb25zJ1xuICAgICAgICAgICAgICAgIDogJ3NlZSBcInZzY29kZVByb3h5T3B0aW9uc1wiIG9wdGlvbiBpbiBzZXJ2aWNlIGRvY3MnXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFZTQ29kZSBBUEkgcHJveHkgbm90IGVuYWJsZWQsICR7ZXJyb3JNZXNzYWdlfWApXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzb2NrZXQgPSBhd2FpdCB0aGlzLl9wcm9taXNlZFNvY2tldFxuXG4gICAgICAgIGNvbnN0IHByb3h5Rm4gPSB0eXBlb2YgZm4gPT09ICdmdW5jdGlvbidcbiAgICAgICAgICAgID8gZm4udG9TdHJpbmcoKVxuICAgICAgICAgICAgOiBmblxuXG4gICAgICAgIHNvY2tldC5zZW5kKEpTT04uc3RyaW5naWZ5KDxSZW1vdGVDb21tYW5kPntcbiAgICAgICAgICAgIGlkOiB0aGlzLl9tZXNzYWdlSWQsXG4gICAgICAgICAgICBmbjogcHJveHlGbixcbiAgICAgICAgICAgIHBhcmFtc1xuICAgICAgICB9KSlcblxuICAgICAgICBjb25zdCByZXR1cm5WYWwgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjbWRUaW1lb3V0ID0gc2V0VGltZW91dChcbiAgICAgICAgICAgICAgICAoKSA9PiByZWplY3QobmV3IEVycm9yKCdSZW1vdGUgY29tbWFuZCB0aW1lb3V0IGV4Y2VlZGVkJykpLFxuICAgICAgICAgICAgICAgIHRoaXMuX3Byb3h5T3B0aW9ucy5jb21tYW5kVGltZW91dFxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgdGhpcy5fcGVuZGluZ01lc3NhZ2VzLnNldCh0aGlzLl9tZXNzYWdlSWQsIChlcnJvcjogc3RyaW5nIHwgdW5kZWZpbmVkLCByZXN1bHQ6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChjbWRUaW1lb3V0KVxuICAgICAgICAgICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QobmV3IEVycm9yKGVycm9yKSlcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJlc29sdmUocmVzdWx0KVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcbiAgICAgICAgdGhpcy5fbWVzc2FnZUlkICs9IDFcbiAgICAgICAgcmV0dXJuIHJldHVyblZhbFxuICAgIH1cbn1cblxuaW50ZXJmYWNlIFZTQ29kZUNvbW1hbmRzIHtcbiAgICBnZXRXb3JrYmVuY2g6ICgpID0+IFByb21pc2U8V29ya2JlbmNoPlxuICAgIC8vIFRvZG8oQ2hyaXN0aWFuKTogcHJvcGVybHkgdHlwZSBWU0NvZGUgb2JqZWN0IGhlcmVcbiAgICBleGVjdXRlV29ya2JlbmNoOiA8VD4oZm46ICh2c2NvZGU6IGFueSwgLi4ucGFyYW1zOiBhbnlbXSkgPT4gVCwgLi4ucGFyYW1zOiBhbnlbXSkgPT4gUHJvbWlzZTxUPlxuICAgIGdldFZTQ29kZVZlcnNpb246ICgpID0+IFByb21pc2U8c3RyaW5nPlxuICAgIGdldFZTQ29kZUNoYW5uZWw6ICgpID0+IFByb21pc2U8c3RyaW5nPlxuICAgIGlzVlNDb2RlV2ViU2Vzc2lvbjogKCkgPT4gUHJvbWlzZTxib29sZWFuPlxufVxuXG5kZWNsYXJlIGdsb2JhbCB7XG4gICAgbmFtZXNwYWNlIFdlYmRyaXZlcklPIHtcbiAgICAgICAgaW50ZXJmYWNlIEJyb3dzZXIgZXh0ZW5kcyBWU0NvZGVDb21tYW5kcyB7fVxuICAgIH1cblxuICAgIG5hbWVzcGFjZSBXZWJkcml2ZXJJT0FzeW5jIHtcbiAgICAgICAgaW50ZXJmYWNlIEJyb3dzZXIgZXh0ZW5kcyBWU0NvZGVDb21tYW5kcyB7fVxuICAgICAgICBpbnRlcmZhY2UgTXVsdGlSZW1vdGVCcm93c2VyIGV4dGVuZHMgVlNDb2RlQ29tbWFuZHMgeyB9XG4gICAgfVxufVxuIl19
import fs from 'node:fs/promises';
import path from 'node:path';
import { URI } from 'vscode-uri';
import { fsProviderExtensionPrefix, fsProviderFolderUri } from './constants.js';
export async function getWorkbenchOptions(ctx, config) {
    const options = {};
    if (config.extensionPaths) {
        const extensionPromises = config.extensionPaths.map((extensionPath, index) => scanForExtensions(extensionPath, {
            scheme: ctx.protocol,
            authority: ctx.host,
            path: `/static/extensions/${index}`
        }));
        options.additionalBuiltinExtensions = (await Promise.all(extensionPromises)).flat();
    }
    if (config.extensionIds) {
        if (!options.additionalBuiltinExtensions) {
            options.additionalBuiltinExtensions = [];
        }
        options.additionalBuiltinExtensions.push(...config.extensionIds);
    }
    if (config.extensionDevelopmentPath) {
        const developmentOptions = options.developmentOptions = {};
        developmentOptions.extensions = await scanForExtensions(config.extensionDevelopmentPath, { scheme: ctx.protocol, authority: ctx.host, path: '/static/devextensions' });
        if (config.extensionTestsPath) {
            let relativePath = path.relative(config.extensionDevelopmentPath, config.extensionTestsPath);
            if (process.platform === 'win32') {
                relativePath = relativePath.replace(/\\/g, '/');
            }
            developmentOptions.extensionTestsPath = {
                scheme: ctx.protocol,
                authority: ctx.host,
                path: path.posix.join('/static/devextensions', relativePath)
            };
        }
    }
    if (config.folderMountPath) {
        if (!options.additionalBuiltinExtensions) {
            options.additionalBuiltinExtensions = [];
        }
        options.additionalBuiltinExtensions.push({
            scheme: ctx.protocol,
            authority: ctx.host,
            path: fsProviderExtensionPrefix
        });
        options.folderUri = URI.parse(fsProviderFolderUri);
    }
    else if (config.folderUri) {
        options.folderUri = URI.parse(config.folderUri);
    }
    else {
        options.workspaceUri = URI.from({ scheme: 'tmp', path: '/default.code-workspace' });
    }
    options.productConfiguration = { enableTelemetry: false };
    return options;
}
export async function scanForExtensions(rootPath, serverURI) {
    const result = [];
    async function getExtension(relativePosixFolderPath) {
        try {
            const packageJSONPath = path.join(rootPath, relativePosixFolderPath, 'package.json');
            if ((await fs.stat(packageJSONPath)).isFile()) {
                return {
                    scheme: serverURI.scheme,
                    authority: serverURI.authority,
                    path: path.posix.join(serverURI.path, relativePosixFolderPath)
                };
            }
        }
        catch {
            return undefined;
        }
        return undefined;
    }
    async function processFolder(relativePosixFolderPath) {
        const extension = await getExtension(relativePosixFolderPath);
        if (extension) {
            result.push(extension);
        }
        else {
            const folderPath = path.join(rootPath, relativePosixFolderPath);
            const entries = await fs.readdir(folderPath, { withFileTypes: true });
            for (const entry of entries) {
                if (entry.isDirectory() && entry.name.charAt(0) !== '.') {
                    await processFolder(path.posix.join(relativePosixFolderPath, entry.name));
                }
            }
        }
    }
    await processFolder('');
    return result;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc2VydmVyL3V0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLGtCQUFrQixDQUFBO0FBQ2pDLE9BQU8sSUFBSSxNQUFNLFdBQVcsQ0FBQTtBQUU1QixPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sWUFBWSxDQUFBO0FBRWhDLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxtQkFBbUIsRUFBRSxNQUFNLGdCQUFnQixDQUFBO0FBd0QvRSxNQUFNLENBQUMsS0FBSyxVQUFVLG1CQUFtQixDQUNyQyxHQUF1QyxFQUN2QyxNQUFlO0lBRWYsTUFBTSxPQUFPLEdBQXNCLEVBQUUsQ0FBQTtJQUNyQyxJQUFJLE1BQU0sQ0FBQyxjQUFjLEVBQUU7UUFDdkIsTUFBTSxpQkFBaUIsR0FBRyxNQUFNLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FDL0MsQ0FBQyxhQUFhLEVBQUUsS0FBSyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxhQUFhLEVBQUU7WUFDdkQsTUFBTSxFQUFFLEdBQUcsQ0FBQyxRQUFRO1lBQ3BCLFNBQVMsRUFBRSxHQUFHLENBQUMsSUFBSTtZQUNuQixJQUFJLEVBQUUsc0JBQXNCLEtBQUssRUFBRTtTQUN0QyxDQUFDLENBQ0wsQ0FBQTtRQUNELE9BQU8sQ0FBQywyQkFBMkIsR0FBRyxDQUFDLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUE7S0FDdEY7SUFDRCxJQUFJLE1BQU0sQ0FBQyxZQUFZLEVBQUU7UUFDckIsSUFBSSxDQUFDLE9BQU8sQ0FBQywyQkFBMkIsRUFBRTtZQUN0QyxPQUFPLENBQUMsMkJBQTJCLEdBQUcsRUFBRSxDQUFBO1NBQzNDO1FBRUQsT0FBTyxDQUFDLDJCQUEyQixDQUFDLElBQUksQ0FBQyxHQUFHLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQTtLQUNu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T0FBTyxTQUFTLENBQUE7SUFDcEIsQ0FBQztJQUVELEtBQUssVUFBVSxhQUFhLENBQUUsdUJBQStCO1FBQ3pELE1BQU0sU0FBUyxHQUFHLE1BQU0sWUFBWSxDQUFDLHVCQUF1QixDQUFDLENBQUE7UUFDN0QsSUFBSSxTQUFTLEVBQUU7WUFDWCxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFBO1NBQ3pCO2FBQU07WUFDSCxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSx1QkFBdUIsQ0FBQyxDQUFBO1lBQy9ELE1BQU0sT0FBTyxHQUFHLE1BQU0sRUFBRSxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQTtZQUNyRSxLQUFLLE1BQU0sS0FBSyxJQUFJLE9BQU8sRUFBRTtnQkFDekIsSUFBSSxLQUFLLENBQUMsV0FBVyxFQUFFLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxFQUFFO29CQUNyRCxNQUFNLGFBQWEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQTtpQkFDNUU7YUFDSjtTQUNKO0lBQ0wsQ0FBQztJQUVELE1BQU0sYUFBYSxDQUFDLEVBQUUsQ0FBQyxDQUFBO0lBQ3ZCLE9BQU8sTUFBTSxDQUFBO0FBQ2pCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgZnJvbSAnbm9kZTpmcy9wcm9taXNlcydcbmltcG9ydCBwYXRoIGZyb20gJ25vZGU6cGF0aCdcblxuaW1wb3J0IHsgVVJJIH0gZnJvbSAndnNjb2RlLXVyaSdcblxuaW1wb3J0IHsgZnNQcm92aWRlckV4dGVuc2lvblByZWZpeCwgZnNQcm92aWRlckZvbGRlclVyaSB9IGZyb20gJy4vY29uc3RhbnRzLmpzJ1xuXG5leHBvcnQgaW50ZXJmYWNlIElDb25maWcge1xuICAgIHJlYWRvbmx5IGV4dGVuc2lvblBhdGhzOiBzdHJpbmdbXSB8IHVuZGVmaW5lZFxuICAgIHJlYWRvbmx5IGV4dGVuc2lvbklkczogR2FsbGVyeUV4dGVuc2lvbkluZm9bXSB8IHVuZGVmaW5lZFxuICAgIHJlYWRvbmx5IGV4dGVuc2lvbkRldmVsb3BtZW50UGF0aDogc3RyaW5nIHwgdW5kZWZpbmVkXG4gICAgcmVhZG9ubHkgZXh0ZW5zaW9uVGVzdHNQYXRoOiBzdHJpbmcgfCB1bmRlZmluZWRcbiAgICByZWFkb25seSBidWlsZDogU291cmNlcyB8IFN0YXRpYyB8IENETlxuICAgIHJlYWRvbmx5IGZvbGRlclVyaTogc3RyaW5nIHwgdW5kZWZpbmVkXG4gICAgcmVhZG9ubHkgZm9sZGVyTW91bnRQYXRoOiBzdHJpbmcgfCB1bmRlZmluZWRcbiAgICByZWFkb25seSBwcmludFNlcnZlckxvZzogYm9vbGVhblxufVxuXG5leHBvcnQgaW50ZXJmYWNlIEdhbGxlcnlFeHRlbnNpb25JbmZvIHtcbiAgICByZWFkb25seSBpZDogc3RyaW5nXG4gICAgcmVhZG9ubHkgcHJlUmVsZWFzZT86IGJvb2xlYW5cbn1cblxuZXhwb3J0IGludGVyZmFjZSBTb3VyY2VzIHtcbiAgICByZWFkb25seSB0eXBlOiAnc291cmNlcydcbiAgICByZWFkb25seSBsb2NhdGlvbjogc3RyaW5nXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU3RhdGljIHtcbiAgICByZWFkb25seSB0eXBlOiAnc3RhdGljJ1xuICAgIHJlYWRvbmx5IGxvY2F0aW9uOiBzdHJpbmdcbiAgICByZWFkb25seSBxdWFsaXR5OiAnc3RhYmxlJyB8ICdpbnNpZGVyJ1xuICAgIHJlYWRvbmx5IHZlcnNpb246IHN0cmluZ1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIENETiB7XG4gICAgcmVhZG9ubHkgdHlwZTogJ2NkbidcbiAgICByZWFkb25seSB1cmk6IHN0cmluZ1xufVxuXG5pbnRlcmZhY2UgSURldmVsb3BtZW50T3B0aW9ucyB7XG4gICAgZXh0ZW5zaW9uVGVzdHNQYXRoPzogVVJJQ29tcG9uZW50c1xuICAgIGV4dGVuc2lvbnM/OiBVUklDb21wb25lbnRzW11cbn1cblxuaW50ZXJmYWNlIFVSSUNvbXBvbmVudHMge1xuICAgIHNjaGVtZTogc3RyaW5nXG4gICAgYXV0aG9yaXR5OiBzdHJpbmdcbiAgICBwYXRoOiBzdHJpbmdcbn1cblxuaW50ZXJmYWNlIElXb3JrYmVuY2hPcHRpb25zIHtcbiAgICBhZGRpdGlvbmFsQnVpbHRpbkV4dGVuc2lvbnM/OiAoc3RyaW5nIHwgVVJJQ29tcG9uZW50cyB8IEdhbGxlcnlFeHRlbnNpb25JbmZvKVtdXG4gICAgZGV2ZWxvcG1lbnRPcHRpb25zPzogSURldmVsb3BtZW50T3B0aW9uc1xuICAgIHByb2R1Y3RDb25maWd1cmF0aW9uPzogeyBba2V5OiBzdHJpbmddOiBhbnkgfVxuXG4gICAgLy8gb3B0aW9ucyBvZiB0aGUgYnVpbHRpbiB3b3JrYmVuY2ggKHZzL2NvZGUvYnJvd3Nlci93b3JrYmVuY2gvd29ya2JlbmNoKVxuICAgIGZvbGRlclVyaT86IFVSSUNvbXBvbmVudHNcbiAgICB3b3Jrc3BhY2VVcmk/OiBVUklDb21wb25lbnRzXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRXb3JrYmVuY2hPcHRpb25zIChcbiAgICBjdHg6IHsgcHJvdG9jb2w6IHN0cmluZywgaG9zdDogc3RyaW5nIH0sXG4gICAgY29uZmlnOiBJQ29uZmlnXG4pOiBQcm9taXNlPElXb3JrYmVuY2hPcHRpb25zPiB7XG4gICAgY29uc3Qgb3B0aW9uczogSVdvcmtiZW5jaE9wdGlvbnMgPSB7fVxuICAgIGlmIChjb25maWcuZXh0ZW5zaW9uUGF0aHMpIHtcbiAgICAgICAgY29uc3QgZXh0ZW5zaW9uUHJvbWlzZXMgPSBjb25maWcuZXh0ZW5zaW9uUGF0aHMubWFwKFxuICAgICAgICAgICAgKGV4dGVuc2lvblBhdGgsIGluZGV4KSA9PiBzY2FuRm9yRXh0ZW5zaW9ucyhleHRlbnNpb25QYXRoLCB7XG4gICAgICAgICAgICAgICAgc2NoZW1lOiBjdHgucHJvdG9jb2wsXG4gICAgICAgICAgICAgICAgYXV0aG9yaXR5OiBjdHguaG9zdCxcbiAgICAgICAgICAgICAgICBwYXRoOiBgL3N0YXRpYy9leHRlbnNpb25zLyR7aW5kZXh9YFxuICAgICAgICAgICAgfSlcbiAgICAgICAgKVxuICAgICAgICBvcHRpb25zLmFkZGl0aW9uYWxCdWlsdGluRXh0ZW5zaW9ucyA9IChhd2FpdCBQcm9taXNlLmFsbChleHRlbnNpb25Qcm9taXNlcykpLmZsYXQoKVxuICAgIH1cbiAgICBpZiAoY29uZmlnLmV4dGVuc2lvbklkcykge1xuICAgICAgICBpZiAoIW9wdGlvbnMuYWRkaXRpb25hbEJ1aWx0aW5FeHRlbnNpb25zKSB7XG4gICAgICAgICAgICBvcHRpb25zLmFkZGl0aW9uYWxCdWlsdGluRXh0ZW5zaW9ucyA9IFtdXG4gICAgICAgIH1cblxuICAgICAgICBvcHRpb25zLmFkZGl0aW9uYWxCdWlsdGluRXh0ZW5zaW9ucy5wdXNoKC4uLmNvbmZpZy5leHRlbnNpb25JZHMpXG4gICAgfVxuICAgIGlmIChjb25maWcuZXh0ZW5zaW9uRGV2ZWxvcG1lbnRQYXRoKSB7XG4gICAgICAgIGNvbnN0IGRldmVsb3BtZW50T3B0aW9uczogSURldmVsb3BtZW50T3B0aW9ucyA9IG9wdGlvbnMuZGV2ZWxvcG1lbnRPcHRpb25zID0ge31cblxuICAgICAgICBkZXZlbG9wbWVudE9wdGlvbnMuZXh0ZW5zaW9ucyA9IGF3YWl0IHNjYW5Gb3JFeHRlbnNpb25zKFxuICAgICAgICAgICAgY29uZmlnLmV4dGVuc2lvbkRldmVsb3BtZW50UGF0aCxcbiAgICAgICAgICAgIHsgc2NoZW1lOiBjdHgucHJvdG9jb2wsIGF1dGhvcml0eTogY3R4Lmhvc3QsIHBhdGg6ICcvc3RhdGljL2RldmV4dGVuc2lvbnMnIH1cbiAgICAgICAgKVxuICAgICAgICBpZiAoY29uZmlnLmV4dGVuc2lvblRlc3RzUGF0aCkge1xuICAgICAgICAgICAgbGV0IHJlbGF0aXZlUGF0aCA9IHBhdGgucmVsYXRpdmUoY29uZmlnLmV4dGVuc2lvbkRldmVsb3BtZW50UGF0aCwgY29uZmlnLmV4dGVuc2lvblRlc3RzUGF0aClcbiAgICAgICAgICAgIGlmIChwcm9jZXNzLnBsYXRmb3JtID09PSAnd2luMzInKSB7XG4gICAgICAgICAgICAgICAgcmVsYXRpdmVQYXRoID0gcmVsYXRpdmVQYXRoLnJlcGxhY2UoL1xcXFwvZywgJy8nKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZGV2ZWxvcG1lbnRPcHRpb25zLmV4dGVuc2lvblRlc3RzUGF0aCA9IHtcbiAgICAgICAgICAgICAgICBzY2hlbWU6IGN0eC5wcm90b2NvbCxcbiAgICAgICAgICAgICAgICBhdXRob3JpdHk6IGN0eC5ob3N0LFxuICAgICAgICAgICAgICAgIHBhdGg6IHBhdGgucG9zaXguam9pbignL3N0YXRpYy9kZXZleHRlbnNpb25zJywgcmVsYXRpdmVQYXRoKVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGlmIChjb25maWcuZm9sZGVyTW91bnRQYXRoKSB7XG4gICAgICAgIGlmICghb3B0aW9ucy5hZGRpdGlvbmFsQnVpbHRpbkV4dGVuc2lvbnMpIHtcbiAgICAgICAgICAgIG9wdGlvbnMuYWRkaXRpb25hbEJ1aWx0aW5FeHRlbnNpb25zID0gW11cbiAgICAgICAgfVxuICAgICAgICBvcHRpb25zLmFkZGl0aW9uYWxCdWlsdGluRXh0ZW5zaW9ucy5wdXNoKHtcbiAgICAgICAgICAgIHNjaGVtZTogY3R4LnByb3RvY29sLFxuICAgICAgICAgICAgYXV0aG9yaXR5OiBjdHguaG9zdCxcbiAgICAgICAgICAgIHBhdGg6IGZzUHJvdmlkZXJFeHRlbnNpb25QcmVmaXhcbiAgICAgICAgfSlcbiAgICAgICAgb3B0aW9ucy5mb2xkZXJVcmkgPSBVUkkucGFyc2UoZnNQcm92aWRlckZvbGRlclVyaSlcbiAgICB9IGVsc2UgaWYgKGNvbmZpZy5mb2xkZXJVcmkpIHtcbiAgICAgICAgb3B0aW9ucy5mb2xkZXJVcmkgPSBVUkkucGFyc2UoY29uZmlnLmZvbGRlclVyaSlcbiAgICB9IGVsc2Uge1xuICAgICAgICBvcHRpb25zLndvcmtzcGFjZVVyaSA9IFVSSS5mcm9tKHsgc2NoZW1lOiAndG1wJywgcGF0aDogJy9kZWZhdWx0LmNvZGUtd29ya3NwYWNlJyB9KVxuICAgIH1cbiAgICBvcHRpb25zLnByb2R1Y3RDb25maWd1cmF0aW9uID0geyBlbmFibGVUZWxlbWV0cnk6IGZhbHNlIH1cbiAgICByZXR1cm4gb3B0aW9uc1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gc2NhbkZvckV4dGVuc2lvbnMgKFxuICAgIHJvb3RQYXRoOiBzdHJpbmcsXG4gICAgc2VydmVyVVJJOiBVUklDb21wb25lbnRzXG4pOiBQcm9taXNlPFVSSUNvbXBvbmVudHNbXT4ge1xuICAgIGNvbnN0IHJlc3VsdDogVVJJQ29tcG9uZW50c1tdID0gW11cbiAgICBhc3luYyBmdW5jdGlvbiBnZXRFeHRlbnNpb24gKHJlbGF0aXZlUG9zaXhGb2xkZXJQYXRoOiBzdHJpbmcpOiBQcm9taXNlPFVSSUNvbXBvbmVudHMgfCB1bmRlZmluZWQ+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHBhY2thZ2VKU09OUGF0aCA9IHBhdGguam9pbihyb290UGF0aCwgcmVsYXRpdmVQb3NpeEZvbGRlclBhdGgsICdwYWNrYWdlLmpzb24nKVxuICAgICAgICAgICAgaWYgKChhd2FpdCBmcy5zdGF0KHBhY2thZ2VKU09OUGF0aCkpLmlzRmlsZSgpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgc2NoZW1lOiBzZXJ2ZXJVUkkuc2NoZW1lLFxuICAgICAgICAgICAgICAgICAgICBhdXRob3JpdHk6IHNlcnZlclVSSS5hdXRob3JpdHksXG4gICAgICAgICAgICAgICAgICAgIHBhdGg6IHBhdGgucG9zaXguam9pbihzZXJ2ZXJVUkkucGF0aCwgcmVsYXRpdmVQb3NpeEZvbGRlclBhdGgpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIHtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWRcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB1bmRlZmluZWRcbiAgICB9XG5cbiAgICBhc3luYyBmdW5jdGlvbiBwcm9jZXNzRm9sZGVyIChyZWxhdGl2ZVBvc2l4Rm9sZGVyUGF0aDogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IGV4dGVuc2lvbiA9IGF3YWl0IGdldEV4dGVuc2lvbihyZWxhdGl2ZVBvc2l4Rm9sZGVyUGF0aClcbiAgICAgICAgaWYgKGV4dGVuc2lvbikge1xuICAgICAgICAgICAgcmVzdWx0LnB1c2goZXh0ZW5zaW9uKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgZm9sZGVyUGF0aCA9IHBhdGguam9pbihyb290UGF0aCwgcmVsYXRpdmVQb3NpeEZvbGRlclBhdGgpXG4gICAgICAgICAgICBjb25zdCBlbnRyaWVzID0gYXdhaXQgZnMucmVhZGRpcihmb2xkZXJQYXRoLCB7IHdpdGhGaWxlVHlwZXM6IHRydWUgfSlcbiAgICAgICAgICAgIGZvciAoY29uc3QgZW50cnkgb2YgZW50cmllcykge1xuICAgICAgICAgICAgICAgIGlmIChlbnRyeS5pc0RpcmVjdG9yeSgpICYmIGVudHJ5Lm5hbWUuY2hhckF0KDApICE9PSAnLicpIHtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgcHJvY2Vzc0ZvbGRlcihwYXRoLnBvc2l4LmpvaW4ocmVsYXRpdmVQb3NpeEZvbGRlclBhdGgsIGVudHJ5Lm5hbWUpKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIGF3YWl0IHByb2Nlc3NGb2xkZXIoJycpXG4gICAgcmV0dXJuIHJlc3VsdFxufVxuIl19